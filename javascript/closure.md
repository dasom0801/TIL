# 클로저 그리고 렉시컬 환경

### 중첩함수(nested function)

- 함수 내부에 선언한 함수이다.
- 중첩 함수는 그 자체로 함수의 반환값이 될 수 있다.
- 반환된 중첩함수는 어디서든 호출해서 사용할 수 있다. 이때도 외부 변수에 접근할 수 있다.

### 렉시컬 환경(Lexical Environment)

- 단계1. 변수
  - 자바스크립트에서 함수, 코드 블록, 스크립트 전체는 렉시컬 환경이라는 객체(이론상의 객체이며 접근할 수 오없음)를 갖는다.
  - 렉시컬 환경의 구성은 다음과 같다.
    - 환경 레코드: 모든 지역 변수를 프로퍼티로 갖는 객체
    - 외부 렉시컬 환경에 대한 참조
  - 변수는 환경 레코드의 프로퍼티이다. 변수를 가져오거나 변경한다는 것은 환경 레코드를 가져오거나 변경한다는 것을 의미한다.
  - 스크립트 전체와 연결된 렉시컬 환경은 전역(글로벌) 렉시컬 환경이라고 한다. 전역 렉시컬은 외부 참조에 대한 값이 null이다.
  - 정리
    - 변수는 특수 내부 객체인 환경 레코드의 프로퍼티이다. 환경 레코드는 현재 실행중인 함수와 코드 블록, 스크립트와 연관되어 있다.
    - 변수를 변경하면 환경 프로퍼티의 값이 변경된다.
- 단계2. 함수 선언문
  - 함수는 변수와 마찬가지로 값이다.
  - 함수 선언문으로 선언된 함수는 일반 변수와 달리 바로 초기화 된다.
  - 함수 선언문으로 선언된 함수는 렉시컬 환경이 만들어지는 즉시 사용할 수 있다. 함수를 변수에 할당한 함수 표현식은 해당하지 않는다.
  - 변수는 let을 만나서 선언될 때까지 사용할 수 없다.
- 단계3. 내부와 외부 렉시컬 환경
  - 함수를 호출해 실행하면 새로운 렉시컬 환경이 자동으로 만들어진다. 이 렉시컬 환경에는 매개변수와 지역변수가 저장된다.
  - 함수가 호출되는 동안에 호출중인 함수를 위한 내부 렉시컬 환경과, 내부 렉시컬 환경이 가리키는 외부 렉시컬 환경을 갖게된다.
  ```jsx
  // say 함수가 실행될 때의 외부 렉시컬 환경
  let pharse = 'hello';
  function say(name) { // 내부 렉시컬 환경
  // pharse는 외부 렉시컬 환경에서 찾고, name은 내부 렉시컬 환경에서 찾는다.
  	alert(`${pharse} `${name});
  }

  say('som');
  ```
  - 내부 렉시컬 환경은 name 프로퍼티만 있다. { name: ‘som’ }
  - 외부 렉시컬 환경은 { pharse: ‘hello’, say: function }
  - 내부 렉시컬 환경은 외부 렉시컬 환경에 대한 참조를 갖는다.
  - 코드에서 변수를 찾는 과정은 다음과 같다.
    - 내부 렉시컬 환경을 검색 범위로 잡고 변수를 찾는다.
    - 내부 렉시컬 환경에서 변수를 찾지 못하면 내부 렉시컬 환경이 참조하는 외부 렉시컬 환경으로 범위를 확장한다.
    - 이 과정을 전역 렉시컬 환경에 도달할 때까지 반복하면서 확장한다.
    - 전역 렉시컬 환경에 도달할 때까지 변수를 찾지 못하는 경우
      - 엄격 모드에서는 에러가 발생한다.
      - 비엄격 모드에서는 에러가 발생하지 않고 전역에 변수가 만들어진다.
- 단계4. 함수를 변환하는 함수
  - 함수를 호출하면 호출할 때마다 새로운 렉시컬 환경 객체가 만들어지고 여기에 함수를 실행하는데 필요한 변수들이 저장된다.
  - 모든 함수는 함수가 생성된 곳의 렉시컬 환경을 기억한다.
  - 함수의 `[[Environment]]` 라는 숨김 프로퍼티에 함수가 만들어진 곳의 렉시컬 환경에 대한 참조가 저장된다.
  - 함수의 호출과 상관없이 자신이 태어난 곳을 기억할 수 있으며, 함수가 생성할 때 딱 한 번 값이 세팅되어 이후로 변경되지 않는다.
  - 함수는 `함수.[[Environment]]` 에 저장된 렉시컬 환경을 외부 렉시컬 환경으로서 참조한다.
  - `함수.[[Environment]]` 에 저장된 렉시컬 환경에 저장된 변수의 값을 갱신하면 해당 렉시컬 환경에서만 변경된다.
  ```jsx
  function makeCounter() {
  	let count = 0;
  	return function () {
  		return count++;
  	};
  }

  // counter 함수는 자신이 생성된 곳의 렉시컬 환경을 외부 렉시컬 환경으로 참조한다.
  let counter = makeCounter();
  counter(); //
  ```

### 클로저 (Closure)

- 클로저는 외부 변수를 기억하고 이 외부 변수에 접근할 수 있는 함수를 의미한다. 자바스크립트에서는 함수가 자연스럽게 클로저가 된다.
- 자바스크립트의 함수는 숨김 프로퍼티인 `[[Environment]]` 를 이용해 자신이 어디에서 만들어졌는지를 기억한다. 함수 본문에서는 `[[Environment]]` 를 통해 외부 변수에 접근할 수 있다.

### 가비지 컬렉션

- 함수의 호출이 끝나면 함수에 대응하는 렉시컬 환경은 메모리에서 제거되기 때문에 함수와 관련된 변수를 참조할 수 없다.
- 중첩 함수를 반환하는 경우 함수의 호출이 끝난 뒤에도 관련된 변수를 참조 할 수 있다. 중첩 함수의 `[[Environment]]` 프로퍼티에 함수의 렉시컬 환경에 대한 정보가 저장되기 때문이다.

```jsx
function f() {
	const value = 123;
	return function () {
		alert(value);
	};
}

const g = f(); // f를 호출할 때 만들어지는 렉시컬 환경이 g.[[Environment]]에 저장된다.
```

- 이렇게 만들어진 렉시컬 환경은 메모리에서 삭제되지 않고 유지된다.
- 객체는 도달할 수 없을 때 메모리에서 삭제되기 때문에 해당 렉시컬 환경 객체를 참조하는 중첩 함수가 하나라도 있으면 사라지지 않는다.

```jsx
g = null; // 렉시컬 환경 객체에 도달할 수 없는 상태가 되기 때문에 메모리에서 삭제된다.
```

- 이론상으로는 함수가 살아있는 동안엔 모든 외부 변수가 메모리에 유지되지만, 실제로는 자바스크립트 엔진이 이를 지속해서 최적화 한다. 자바스크립트 엔진은 변수 사용을 분석하고 외부 변수가 사용되지 않는다고 판단되면 이를 메모리에서 제거한다.

출처:

https://ko.javascript.info/closure
